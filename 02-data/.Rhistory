return(tab)
}
nested_ma_main <- nested_ma %>%
filter(model != "RQ2-int") %>%
mutate(tab = pmap(list(data, model, focal, exclusion), ma_tab_fun))
nested_ma_main
ma_tab_fun <- function(d, rq, focal, exclusion){
cap <- "Interaction between Emotion and Emotion Regulation Goals (RQ2 interaction)"
cap <- sprintf("<strong>Table SX</strong><br><em>Meta-Analytic Estimates and Descriptive Statistics of %s </em>", cap)
d <- d %>%
mutate(
ergoal = mapvalues(ergoal, c("goalNeg", "goalPos"), c("Goal to Change Negative Emotions", "Goal to Change Positive Emotions"))
, emo_item = paste(emo_item, "Emotion")
) %>%
separate(parameter, c("param", "ergoal_lev")) %>%
mutate_at(vars(param, ergoal_lev), str_to_title) %>%
mutate(ergoal_lev = factor(ergoal_lev, c("Decrease", "Maintain", "Increase"))) %>%
arrange(emo_item, ergoal, param, ergoal_lev) %>%
unite(comb, emo_item, ergoal, sep = ": ")
cols <- c("Parameter","Emotion Regulation Goal", "M [CI]", "SD [CI]", "Min", "Max")
rs <- d %>% group_by(comb) %>% tally() %>%
mutate(end = cumsum(n), start = lag(end) + 1, start = ifelse(is.na(start), 1, start))
tab <- d %>%
select(-comb) %>%
kable(
.
, round = 2
, "html"
, col.names = cols
, escape = F
, align = c(rep("l", 2), rep("c", 4))
, cap = cap
) %>%
kable_classic(html_font = "Times", full_width = F) #%>%
# collapse_rows(1)
for (i in 1:nrow(rs)){
tab <- tab %>%
kableExtra::group_rows(rs$comb[i], rs$start[i], rs$end[i])
}
tab
save_kable(tab, file = sprintf("../05-results/tables/RQ2-int/key-terms/tabSx-rq2int-%s-%s-ma-addExcl.html", focal, exclusion))
return(tab)
}
nested_ma_int <- nested_ma %>%
filter(model == "RQ2-int") %>%
mutate(tab = pmap(list(data, model, focal, exclusion), ma_tab_fun))
nested_ma_int %>% filter(focal == "focal") %>% pull(tab)
mr_fun <- function(d, mod, emo, er, param, type, o_item, exc){
frm <- if(type == "linear") "~ o_value" else "~ o_value + o_value_2"
m <- rma(
yi = mean
, sei = sd
, mods = as.formula(frm)
, data = d
)
save(m, file = sprintf("../05-results/%s/addExcl/mr-models/%s-%s-%s-%s-%s-%s.RData", mod, emo, er, param, o_item, type, exc))
fx <- tidy(m, conf.int = T)
save(fx, file = sprintf("../05-results/%s/addExcl/mr-fx/%s-%s-%s-%s-%s-%s.RData", mod, emo, er, param, o_item, type, exc))
return(NULL)
}
z_score <- function(x) (x - mean(x, na.rm = T))/sd(x, na.rm = T)
mr_nested <- crossing(
type = c("linear", "quadratic")
, ma_nested# %>% select(-fx)
) %>%
crossing(
.
, wb_long %>%
rename(o_value = wb_value, o_item = wb_item) %>%
mutate(cat = "wb") %>%
full_join(
erstrat %>%
select(SID, er_strat_rep:avg_talkPos) %>%
pivot_longer(
cols = -SID
, names_to = "o_item"
, values_to = "o_value"
) %>%
mutate(cat = "ER")
) %>%
group_by(o_item) %>%
mutate(
o_value = z_score(o_value)
, o_value_2 = o_value^2
, SID = as.character(SID)
) %>%
group_by(cat, o_item) %>%
nest() %>%
ungroup() %>%
rename(cor_data = data)
) %>%
filter(!(cat == "ER" & type == "quadratic")) %>%
mutate(data = map2(data, cor_data, ~(.x) %>% left_join(.y))) %>%
select(-cor_data)
score <- function(x) {y <- if(any(x == 1)) 1 else 0}
erstrat_long <- ema_long %>%
filter(category == "emotion regulation strategies") %>%
group_by(SID, sample, StartDate, item_name) %>%
summarize(value = score(value)) %>%
group_by(SID, sample, StartDate) %>%
summarize(er_strat_rep = sum(value, na.rm = T)) %>%
ungroup()
ema_strat_use <- ema_long %>%
filter(category == "emotion regulation strategies") %>%
group_by(SID, sample, StartDate, item_name, Date) %>%
summarize(value = score(value)) %>%
group_by(SID, sample, StartDate, Date) %>%
summarize(er_strat_rep = score(value))  %>%
ungroup()
erstrat_avg <- ema_long %>%
filter(category == "emotion regulation strategies") %>%
group_by(SID, StartDate, item_name)%>%
summarize(avg_use = mean(value), .groups = "drop") %>%
pivot_wider(names_from = item_name, values_from = avg_use, names_prefix = "avg_")
erstrat<-left_join(erstrat_long,erstrat_avg)
mr_nested <- crossing(
type = c("linear", "quadratic")
, ma_nested# %>% select(-fx)
) %>%
crossing(
.
, wb_long %>%
rename(o_value = wb_value, o_item = wb_item) %>%
mutate(cat = "wb") %>%
full_join(
erstrat %>%
select(SID, er_strat_rep:avg_talkPos) %>%
pivot_longer(
cols = -SID
, names_to = "o_item"
, values_to = "o_value"
) %>%
mutate(cat = "ER")
) %>%
group_by(o_item) %>%
mutate(
o_value = z_score(o_value)
, o_value_2 = o_value^2
, SID = as.character(SID)
) %>%
group_by(cat, o_item) %>%
nest() %>%
ungroup() %>%
rename(cor_data = data)
) %>%
filter(!(cat == "ER" & type == "quadratic")) %>%
mutate(data = map2(data, cor_data, ~(.x) %>% left_join(.y))) %>%
select(-cor_data)
plan(multisession(workers = 12L))
mr_nested %>%
mutate(ma =
future_pmap(
# pmap(
list(data, model, emo_item, ergoal, parameter, type, o_item, exclusion)
, .f = possibly(mr_fun, NA_real_)
, .progress = T
, .options = furrr_options(packages = c("brms", "broom.mixed", "metafor"))
))
loadRData <- function(file, obj, rq){
file <- sprintf("../05-results/%s/addExcl/mr-fx/%s", rq, file)
load(file)
get(ls()[grepl(obj, ls())])
}
mr_nested <- tibble(model = c("RQ1", "RQ2-int", "RQ2-main")) %>%
mutate(file = map(model, ~list.files(sprintf("../05-results/%s/addExcl/mr-fx", .)))) %>%
unnest(file) %>%
mutate(fx = pmap(list(file, "fx", model), loadRData)) %>%
separate(file, c("emo_item", "ergoal", "parameter", "o_item", "type", "exclusion"), sep = "-") %>%
mutate(
exclusion = str_remove_all(exclusion, ".RData")
, ergoal = ifelse(ergoal == "NA", NA_real_, ergoal)
) %>%
filter(!is.na(exclusion)) %>%
left_join(
summ_df %>%
group_by(model, emo_item, ergoal, parameter, exclusion) %>%
filter(!parameter %in% c("mu_E", "sigma_E", "sigma_p")) %>%
nest() %>%
ungroup() %>%
arrange(model, emo_item, ergoal, parameter)
) %>%
mutate(fx = map(fx, ~(.) %>% select(-matches("type"))))
mr_fx <- mr_nested %>%
select(-data) %>%
unnest(fx) %>%
filter(
(type == "linear" & term == "o_value") |
(type == "quadratic" & term == "o_value_2")
) %>%
mutate(
sig = ifelse(sign(conf.low) == sign(conf.high), "sig", "ns")
, focal = ifelse(emo_item %in% c("Positive", "Negative"), "focal", "sup")
) %>%
mutate_at(vars(estimate, conf.low, conf.high), ~sprintf("%.2f", .)) %>%
mutate(
CI = sprintf("[%s, %s]", conf.low, conf.high)
, est = sprintf("%s<br>[%s, %s]", estimate, conf.low, conf.high)
) %>%
mutate_at(vars(est, estimate, CI), ~ifelse(sig == "sig", sprintf("<strong>%s</strong>", .), .)) %>%
select(model, exclusion, o_item, emo_item, ergoal, parameter, type, term, focal, est, estimate, CI)
rq3_rq1_tab_fun <- function(d, exclusion, focal){
# h1 <- rep(1, 9); names(h1) <- c(" ", rep(c("Linear", "Quadratic"), times = 4))
h2 <- c(2, rep(1, 4)); names(h2) <- c(" ", rep(c("Attractor Strength", "Attractor Location"), times = 2))
h3 <- c(2, rep(2, 2)); names(h3) <- c(" ", "Negative Emotion", "Positive Emotion")
# h2 <- c(2, rep(2, 4)); names(h2) <- c(" ", rep(c("Attractor Strength", "Attractor Location"), times = 2))
# h3 <- c(2, rep(4, 2)); names(h3) <- c(" ", "Negative Emotion", "Positive Emotion")
tab <- d %>%
select(
o_item, type, matches("Negative_beta")
, matches("Negative_loc"), matches("Positive_beta")
, matches("Positive_loc")
) %>%
kable(
.
, "html"
, escape = F
# , col.names = c("Well-Being/ER Indicator", "Term", rep(c("Est.", "[CI]"), times = 4))
, col.names = c("Well-Being/ER Indicator", "Term", rep("Est. [CI]", times = 4))
, align = c("l", "l", rep("c", 4))
# , align = c("l", "l", rep("c", 8))
, cap = "<strong>Table X</strong><br><em>Linear and Quadratic Associations Between Emotion Regulation and Well-Being Indicators and Emotion Attractor Location and Strength</em>"
) %>%
kable_classic(full_width = F, html_font = "Times") %>%
# add_header_above(h1) %>%
add_header_above(h2) %>%
add_header_above(h3)
save_kable(tab, file = sprintf("../05-results/tables/tab-x-rq3b-emo-wb-correlates-%s-%s.html", focal, exclusion))
return(tab)
}
tab <- d %>%
select(
o_item, type, matches("Negative_beta")
, matches("Negative_loc"), matches("Positive_beta")
, matches("Positive_loc")
) %>%
kable(
.
, "html"
, escape = F
# , col.names = c("Well-Being/ER Indicator", "Term", rep(c("Est.", "[CI]"), times = 4))
, col.names = c("Well-Being/ER Indicator", "Term", rep("Est. [CI]", times = 4))
, align = c("l", "l", rep("c", 4))
# , align = c("l", "l", rep("c", 8))
, cap = "<strong>Table X</strong><br><em>Linear and Quadratic Associations Between Emotion Regulation and Well-Being Indicators and Emotion Attractor Location and Strength</em>"
) %>%
kable_classic(full_width = F, html_font = "Times") %>%
# add_header_above(h1) %>%
add_header_above(h2) %>%
add_header_above(h3)
tab <- d %>%
select(
o_item, type, matches("Negative_beta")
, matches("Negative_loc"), matches("Positive_beta")
, matches("Positive_loc")
) %>%
kable(
.
, "html"
, escape = F
# , col.names = c("Well-Being/ER Indicator", "Term", rep(c("Est.", "[CI]"), times = 4))
, col.names = c("Well-Being/ER Indicator", "Term", rep("Est. [CI]", times = 4))
, align = c("l", "l", rep("c", 4))
# , align = c("l", "l", rep("c", 8))
, cap = "<strong>Table X</strong><br><em>Linear and Quadratic Associations Between Emotion Regulation and Well-Being Indicators and Emotion Attractor Location and Strength</em>"
) %>%
kable_classic(full_width = F, html_font = "Times") %>%
# add_header_above(h1) %>%
add_header_above(h2) %>%
add_header_above(h3)%>%
save_kable(tab, file = sprintf("../05-results/tables/tab-x-rq3b-emo-wb-correlates-addExcl%s-%s.html", focal, exclusion))
rq3_rq1_tab_fun <- function(d, exclusion, focal){
# h1 <- rep(1, 9); names(h1) <- c(" ", rep(c("Linear", "Quadratic"), times = 4))
h2 <- c(2, rep(1, 4)); names(h2) <- c(" ", rep(c("Attractor Strength", "Attractor Location"), times = 2))
h3 <- c(2, rep(2, 2)); names(h3) <- c(" ", "Negative Emotion", "Positive Emotion")
# h2 <- c(2, rep(2, 4)); names(h2) <- c(" ", rep(c("Attractor Strength", "Attractor Location"), times = 2))
# h3 <- c(2, rep(4, 2)); names(h3) <- c(" ", "Negative Emotion", "Positive Emotion")
tab <- d %>%
select(
o_item, type, matches("Negative_beta")
, matches("Negative_loc"), matches("Positive_beta")
, matches("Positive_loc")
) %>%
kable(
.
, "html"
, escape = F
# , col.names = c("Well-Being/ER Indicator", "Term", rep(c("Est.", "[CI]"), times = 4))
, col.names = c("Well-Being/ER Indicator", "Term", rep("Est. [CI]", times = 4))
, align = c("l", "l", rep("c", 4))
# , align = c("l", "l", rep("c", 8))
, cap = "<strong>Table X</strong><br><em>Linear and Quadratic Associations Between Emotion Regulation and Well-Being Indicators and Emotion Attractor Location and Strength</em>"
) %>%
kable_classic(full_width = F, html_font = "Times") %>%
# add_header_above(h1) %>%
add_header_above(h2) %>%
add_header_above(h3)%>%
save_kable(tab, file = sprintf("../05-results/tables/tab-x-rq3b-emo-wb-correlates-addExcl%s-%s.html", focal, exclusion))
return(tab)
}
rq3b_1_tab <- mr_fx %>%
filter(model == "RQ1") %>%
select(-ergoal) %>%
# select(-term, -model, -est) %>%
select(-term, -model, -estimate, -CI) %>%
pivot_wider(
names_from = c("emo_item", "parameter")
# , values_from = c("estimate", "CI")
, values_from = c("est")
, names_glue = "{emo_item}_{parameter}_{.value}"
) %>%
mutate(o_item = factor(o_item, cor_items$old_name, cor_items$long_name)) %>%
arrange(exclusion, focal, o_item, type) %>%
group_by(exclusion, focal) %>%
nest() %>%
ungroup() %>%
mutate(tab = pmap(list(data, exclusion, focal), rq3_rq1_tab_fun))
rq3_rq1_tab_fun <- function(d, exclusion, focal){
# h1 <- rep(1, 9); names(h1) <- c(" ", rep(c("Linear", "Quadratic"), times = 4))
h2 <- c(2, rep(1, 4)); names(h2) <- c(" ", rep(c("Attractor Strength", "Attractor Location"), times = 2))
h3 <- c(2, rep(2, 2)); names(h3) <- c(" ", "Negative Emotion", "Positive Emotion")
# h2 <- c(2, rep(2, 4)); names(h2) <- c(" ", rep(c("Attractor Strength", "Attractor Location"), times = 2))
# h3 <- c(2, rep(4, 2)); names(h3) <- c(" ", "Negative Emotion", "Positive Emotion")
tab <- d %>%
select(
o_item, type, matches("Negative_beta")
, matches("Negative_loc"), matches("Positive_beta")
, matches("Positive_loc")
) %>%
kable(
.
, "html"
, escape = F
# , col.names = c("Well-Being/ER Indicator", "Term", rep(c("Est.", "[CI]"), times = 4))
, col.names = c("Well-Being/ER Indicator", "Term", rep("Est. [CI]", times = 4))
, align = c("l", "l", rep("c", 4))
# , align = c("l", "l", rep("c", 8))
, cap = "<strong>Table X</strong><br><em>Linear and Quadratic Associations Between Emotion Regulation and Well-Being Indicators and Emotion Attractor Location and Strength</em>"
) %>%
kable_classic(full_width = F, html_font = "Times") %>%
# add_header_above(h1) %>%
add_header_above(h2) %>%
add_header_above(h3)%>%
save_kable(tab, file = sprintf("../05-results/tables/tab-x-rq3b-emo-wb-correlates-addExcl%s-%s.html", focal, exclusion))
return(tab)
}
rq3b_1_tab <- mr_fx %>%
filter(model == "RQ1") %>%
select(-ergoal) %>%
# select(-term, -model, -est) %>%
select(-term, -model, -estimate, -CI) %>%
pivot_wider(
names_from = c("emo_item", "parameter")
# , values_from = c("estimate", "CI")
, values_from = c("est")
, names_glue = "{emo_item}_{parameter}_{.value}"
) %>%
mutate(o_item = factor(o_item, cor_items$old_name, cor_items$long_name)) %>%
arrange(exclusion, focal, o_item, type) %>%
group_by(exclusion, focal) %>%
nest() %>%
ungroup() %>%
mutate(tab = pmap(list(data, exclusion, focal), rq3_rq1_tab_fun))
mr_fx <- mr_nested %>%
select(-data) %>%
unnest(fx) %>%
filter(
(type == "linear" & term == "o_value") |
(type == "quadratic" & term == "o_value_2")
) %>%
mutate(
sig = ifelse(sign(conf.low) == sign(conf.high), "sig", "ns")
, focal = ifelse(emo_item %in% c("Positive", "Negative"), "focal", "sup")
) %>%
mutate_at(vars(estimate, conf.low, conf.high), ~sprintf("%.2f", .)) %>%
mutate(
CI = sprintf("[%s, %s]", conf.low, conf.high)
, est = sprintf("%s<br>[%s, %s]", estimate, conf.low, conf.high)
) %>%
mutate_at(vars(est, estimate, CI), ~ifelse(sig == "sig", sprintf("<strong>%s</strong>", .), .)) %>%
select(model, exclusion, o_item, emo_item, ergoal, parameter, type, term, focal, est, estimate, CI)
rq3_rq1_tab_fun <- function(d, exclusion, focal){
# h1 <- rep(1, 9); names(h1) <- c(" ", rep(c("Linear", "Quadratic"), times = 4))
h2 <- c(2, rep(1, 4)); names(h2) <- c(" ", rep(c("Attractor Strength", "Attractor Location"), times = 2))
h3 <- c(2, rep(2, 2)); names(h3) <- c(" ", "Negative Emotion", "Positive Emotion")
# h2 <- c(2, rep(2, 4)); names(h2) <- c(" ", rep(c("Attractor Strength", "Attractor Location"), times = 2))
# h3 <- c(2, rep(4, 2)); names(h3) <- c(" ", "Negative Emotion", "Positive Emotion")
tab <- d %>%
select(
o_item, type, matches("Negative_beta")
, matches("Negative_loc"), matches("Positive_beta")
, matches("Positive_loc")
) %>%
kable(
.
, "html"
, escape = F
# , col.names = c("Well-Being/ER Indicator", "Term", rep(c("Est.", "[CI]"), times = 4))
, col.names = c("Well-Being/ER Indicator", "Term", rep("Est. [CI]", times = 4))
, align = c("l", "l", rep("c", 4))
# , align = c("l", "l", rep("c", 8))
, cap = "<strong>Table X</strong><br><em>Linear and Quadratic Associations Between Emotion Regulation and Well-Being Indicators and Emotion Attractor Location and Strength</em>"
) %>%
kable_classic(full_width = F, html_font = "Times") %>%
# add_header_above(h1) %>%
add_header_above(h2) %>%
add_header_above(h3)%>%
save_kable(tab, file = sprintf("../05-results/tables/tab-x-rq3b-emo-wb-correlates-addExcl%s-%s.html", focal, exclusion))
return(tab)
}
rq3b_1_tab <- mr_fx %>%
filter(model == "RQ1") %>%
select(-ergoal) %>%
# select(-term, -model, -est) %>%
select(-term, -model, -estimate, -CI) %>%
pivot_wider(
names_from = c("emo_item", "parameter")
# , values_from = c("estimate", "CI")
, values_from = c("est")
, names_glue = "{emo_item}_{parameter}_{.value}"
) %>%
mutate(o_item = factor(o_item, cor_items$old_name, cor_items$long_name)) %>%
arrange(exclusion, focal, o_item, type) %>%
group_by(exclusion, focal) %>%
nest() %>%
ungroup() %>%
mutate(tab = pmap(list(data, exclusion, focal), rq3_rq1_tab_fun))
mr_fx
View(mr_fx)
View(filter(mr_fx,emo_items="Positive"))
View(filter(mr_fx,emo_items=="Positive"))
View(filter(mr_fx,emo_items=="Positive"))
filter(mr_fx,emo_items=="Positive")
View(filter(mr_fx,emo_item=="Positive"))
View(filter(mr_fx,emo_item=="Positive"&o_item=="DEP"&focal=="focal"))
View(filter(mr_fx,emo_item=="Positive"&o_item=="DEP"&focal=="focal"&parameter=="strength_increase"))
View(filter(mr_fx,emo_item=="Positive"&o_item=="DEP"&focal=="focal"&parameter=="strength_increase"& type=="linear"))
{library(ggplot2)
library(dplyr)
library(tidyr)
library(faux)
library(lmerTest)
library(MASS)
}
set.seed(999)
# create number of ppts and days
ppt <- 100
days <- 28
# create the data frame
data1 <- data.frame(
id = rep(1:ppt, each = days),
day = rep(1:days, times = ppt)
)
# add between variable for political affiliation
pol_aff <- sample(1:7, ppt, replace = TRUE)
data1$pol_aff <- pol_aff[data1$id]
# add slope for emotion variable
slope1 <- mvrnorm(ppt, mu = c(10, -2),
Sigma = matrix(c(4, 1, 1, 2), nrow = 2))
# simulate emotion variable
emotion <- c(NA)
for(i in 1:nrow(data1)){
df1 <- data1[i,]
emotion[i] <- slope1[df1$id, 1] + df1$day * slope1[df1$id, 2] + rnorm(1)
}
data1$emotion <- emotion
ggplot(aes(x = day, y = emotion), data = data1) +
geom_line(aes(group = id), color = "gray") +
geom_smooth(aes(group = 1), method = "lm", linewidth = 3, color = "red", se = FALSE) +
theme_bw()
model1 <- lmer(emotion ~ day + pol_aff + (1 | id), data = data1)
model1
summary(model1)
ppt <- 100
days <- 28
# create df
data2 <- data.frame(
id = rep(1:ppt, each = days),
day = rep(1:days, times = ppt),
time = rep(0:(days-1), times = ppt),
timepre = rep(c(-7,-6, -5, -4, -3, -2, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), times = ppt),
timepost = rep(c(0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20), times = ppt)
)
# add between variable for political affiliation
pol_aff <- sample(1:7, ppt, replace = TRUE)
data2$pol_aff <- pol_aff[data2$id]
# create slope to help create emotion variable
slope2 <- mvrnorm(ppt, mu = c(10, 0, -2),
Sigma = matrix(c(4, 0, 0, 0, 1, 0, 0, 0, 2),byrow = TRUE, nrow = 3))
# simulate emotion variable
emotion <- c(NA)
for(i in 1:nrow(data2)){
df2 <- data2[i,]
emotion[i] <- slope2[df2$id, 1] +
df2$timepre * slope2[df2$id, 2] +
df2$timepost * slope2[df2$id, 3] +
rnorm(1)
}
data2$emotion <- emotion
ggplot(aes(x = time, y = emotion), data = data2) +
geom_line(aes(group = id), color = "gray") +
geom_smooth(aes(group = 1), size = 3, color = "red", se = FALSE) +
theme_bw()
model2 <- lmer(emotion ~ 1+ timepre + timepost + pol_aff + (1 + timepre+timepost| id), data = data2)
model2
# basic main effect model
model3a <- lmer(emotion ~ 1+ timepre  + timepost + pol_aff + (1 + timepre+timepost| id), data = data2)
model2
summary(model3a)
#interaction model
model3b <- lmer(emotion ~ 1+ timepre* pol_aff  + timepost * pol_aff + (1 + timepre+timepost| id), data = data2)
model2
summary(model3b)
